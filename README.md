# Notes
  The project was generated using the ["STM32CubeMX"]() program for the ["STM32CubeIDE"]() environment. The code was implemented in such a way as to be able to regenerate the code (settings, pinout, etc.) or transfer the code to another microcontroller from stm32 using CubeMX, with a minimum of labor
___
# Content
- [Project structure](#notes)
  - [Folders](#content)
  - [Basic settings files](#basic-settings-files)
- [Changes and innovations](#changes-and-innovations)
  - [Launching the application](#launching-the-application)
  - [Initialization of the periphery](initialization-of-the-periphery)
  - [Interrupts](#interrupts)
  - [Memory sections](#memory-sections)
  - [freeRTOS](#freertos)
  - [LWIP](#lwip)
  - [ASF Zigbee](#asf-zigbee)
  - [WolfSSL](#wolfssl)
  - [AWS](#aws)
  - [Consol](#consol)
  - [Internal flash manager](#internal-flash-manager)
- [Programs used](#programs-used)

## Project structure
### Folders
- [Components](/Components) - contains the components included in the project.Includes logic, implementations, descriptions
- [Hermes](/Components/Hermes) - contains the basic logic of the device's "hub"
  - [Console](/Components/Hermes/Console) - contains logic for interacting with the outside world via UART
  - [MQTT](/MQTT) - contains a stack for working with MQTT
  - [Settings](/Components/Hermes/Settings) - contains files with settings
  - [Sources](/Components/Hermes/Sources) - contains the basic logic
  - [Surenet](/Components/Hermes/Surenet) - contains the basic logic for working with Zigbee peripherals
    - [SureNetDriver](/Components/Hermes/Surenet/SureNetDriver) - contains a driver for working with the zigbee stack from Microchip ASF
- [Libs](/Libs) - contains a low-level library for working with peripheral modules and their description
- [Common](/Libs/Common) - contains general type libraries
- [Wireless](/Libs/Wireless) - contains a library for working with Zigbee from Microchip ASF
- [Shematic](/Shematic) - contains electrical circuit diagrams and pcb boards
- [Documents](/Documents) - contains the manuals of the peripheral chips and other documents
- Folders generated by STM32CubeMX:
- [Core](/Core) - contains initialization of the periphery and entry point
- [Drivers](/Drivers) - contains HAL drivers
- [Middlewares](/Middlewares)
  - [FreeRTOS](/Middlewares/Third_Party/FreeRTOS/Source)
    - [FreeRTOS-Plus-CLI](/Middlewares/Third_Party/FreeRTOS/FreeRTOS-Plus-CLI) - added manually
  - [wolfssl](/Middlewares/Third_Party/wolfSSL_wolfSSL_wolfSSL/wolfssl)
- [STM32CubeIDE](/STM32CubeIDE) - contains a project
___
### Basic settings files
___
## Changes and innovations

### Launching the application
  - The entry point and initialization of the system is located in the [main.c](/Core/Src/main.c) file
  - Previously, before initializing the Ethernet module and the zigbee transceiver, a pause is maintained around [HERMES_PERIPHERAL_STABILIZATION_TIME_MS]() = 4000 ms to stabilize the power supply and internal initialization of the peripheral device. the definition for HERMES_PERIPHERAL_STABILIZATION_TIME_MS can be changed in the [Hermes-compiler.h](/Components/Hermes/Sources/Hermes-compiller.h) file
  - Initialization and launch of the [Hermes]() component is located in the [freertos.c](/Core/Src/freertos.c) file

### Initialization of the periphery
  - The initialization of pins is located in the [gpio.c](/Core/Src/gpio.c) file
  - The initialization of the timers and the associated pins of the microcontroller is in the [tim.c](/Core/Src/tim.c) file
___
### Interrupts
  - 
  - The initialization of timers is located in the [tim.c](/Core/Src/tim.C) file
___
### Memory sections
  - The [linker script](/STM32CubeIDE/STM32H723ZGTX_FLASH.ld) with a description of the regions
  - The "Heap" and "Stack" area are placed in the "DTCMRAM" section
  - The file [Hermes-compiler.h](/Components/Hermes/Sources/Hermes-compiller.h) has been added, which includes definitions of memory areas for tasks, arrays and structures. The file also contains a macros for determining the packaging of structures
  - The MTU is also configured for the correct operation of the DMA with the "RAM_D1" and "RAM_D2" sections
___
### freeRTOS
  - The library is configured and generated using the program "STM32CubeMX"
  - The configuration file [FreeRTOSConfig.h](/Core/Inc/FreeRTOSConfig.h) is located in the [Core](/Core/Inc) folder
  - The main file of the initialization task is located in the [freertos.c](/Core/Src/freertos.c) file
  - The "ucHeap" for FreeRTOS is declared in the [freertos.c](/Core/Src/freertos.c) file
  - The memory heap for "FreeRTOS" is defined in the region "RAM_D1" the main reason is the frequent accesses to read and write data buffered in the FreeRTOS heap in ethernet, which prevents errors from the DMA of the ethernet module
  - The main tasks and some queues of the Hermes application are initialized statically, for visual memory monitoring, with the possibility of installing a memory partition. You can set the stack size, priority, and memory regions in the [Hermes-compiler.h](/Components/Hermes/Sources/Hermes-compiller.h) file
___
### LWIP
  - General
    - The FreeRTOS-Plus-TCP stack has been replaced with LWIP, which is included in the "STM32CubeMX" program makes it easy to configure and there are many examples of use
  - The library is configured and generated using the program "STM32CubeMX"
  - Initialization files
    - [lwip.c](/LWIP/App/lwip.c) - lwip initialization
    - [ethernetif.c](/LWIP/Target/ethernetif.c) - initialization of the transceiver driver and the ethernet module
  - Configuration files
    - [lwipopts.h](/LWIP/Target/lwipopts.h) - user settings file - recommended for use
    - [opt.h](/Middlewares/Third_Party/LwIP/src/include/lwip/opt.h) - shared settings file - not recommended for use
  - Features of use
    - For correct transmission and reception of data, they must be located in the memory sections "RAM_D1" or "RAM_D2" otherwise a DMA error will be caused
    - When the project is being rebuilt via "STM32CubeMX" - it is necessary to set the definition value "ETH_RX_BUFFER_CNT = 32" in the [ethernetif.c](/LWIP/Target/ethernetif.c) - it cannot be done in the "STM32CubeMX" settings
___
### ASF Zigbee
  - The library is located in the [Wireless](/Libs/Wireless) folder
  - Added additional functions (wrappers) at the code injection site due to the specifics of working with MAC and placed in the [SureNetDriver.c](/Components/Hermes/Surenet/SureNetDriver/SureNetDriver.c) file
  - Updates to the library interaction layer
    - [common_sw_timer.c](/Libs/Wireless/avr2025_mac/source/pal/common_sw_timer/common_sw_timer.c) - the library's internal program timer
    - [trx_access.c](/Libs/Wireless/services/trx_access/trx_access.c) - layer for working with the SPI module
  - Settings files
    - [app_config.h](/Libs/Wireless/app_config.h) - configuring buffers
    - [mac_user_build_config.h](/Libs/Wireless/mac_user_build_config.h) - stack setup
___
### WolfSSL
  - The library is generated using "STM32CubeMX" using additional Software packs
  - When rebuilding the project using "STM32CubeMX", it is necessary to delete the file [wolfSSL.I-CUBE-wolfSSL_conf.h]() located in the [wolfSSL](/wolfSSL) folder. The desired configuration file [wolfSSL.I-CUBE-wolfSSL_conf.h](/Components/Hermes/Settings/wolfSSL.I-CUBE-wolfSSL_conf.h) is located in the [Settings](/Components/Hermes/Settings) folder
___
### Consol
  - Rewritten fsl_debug_console
  
___
### Internal flash manager
  - General description of flash memory
    - From the specifics of the controller used, there is one bank that includes 8 pages of 131072 bytes each.
    - To overwrite the memory, you need to first clear the necessary pages
  - Control has been rewritten to work with flash memory. Memory recording is performed by pre-reading data into the RAM buffer, changes in the RAM buffer, erase the flash memory section, writing the buffer to flash memory.
  - The logic is implemented in the [InternalFlashManager.c](/Components/Hermes/Sources/InternalFlashManager.c) file
___
### Programs used
- [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html) program version 6.6.1
- [STM32CubeIDE](https://www.st.com/en/development-tools/stm32cubeide.html) program version 1.10.1